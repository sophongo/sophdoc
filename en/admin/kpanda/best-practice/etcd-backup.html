
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="Suanova documentation website." name="description"/>
<meta content="Suanova" name="author"/>
<link href="https://sophdoc.github.io/en/admin/kpanda/best-practice/etcd-backup.html" rel="canonical"/>
<link href="../gpu/FAQ.html" rel="prev"/>
<link href="backup-mysql-on-nfs.html" rel="next"/>
<link href="../../../../images/favicon.ico" rel="icon"/>
<meta content="mkdocs-1.6.0, mkdocs-material-9.5.30" name="generator"/>
<title>Backup and Restore etcd - 豐收二號檔案站</title>
<link href="../../../../assets/stylesheets/main.3cba04c6.min.css" rel="stylesheet"/>
<link href="../../../../assets/stylesheets/palette.06af60db.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<link href="../../../../stylesheets/custom.css" rel="stylesheet"/>
<script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="indigo" data-md-color-primary="indigo" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#etcd-backup-and-restore">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="豐收二號檔案站" class="md-header__button md-logo" data-md-component="logo" href="../../../index.html" title="豐收二號檔案站">
<img alt="logo" src="../../../../images/suanova.png"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            豐收二號檔案站
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Backup and Restore etcd
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="(prefers-color-scheme)" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9h-1.9M20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69m-9.15 3.96h2.3L12 9l-1.15 3.65Z"></path></svg>
</label>
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_2" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"></path></svg>
</label>
<input aria-label="Switch to system preference" class="md-option" data-md-color-accent="indigo" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary="indigo" data-md-color-scheme="slate" id="__palette_2" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to system preference">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"></path></svg>
</label>
</form>
<script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<div class="md-header__option">
<div class="md-select">
<button aria-label="Select language" class="md-header__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m12.87 15.07-2.54-2.51.03-.03A17.52 17.52 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04M18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12m-2.62 7 1.62-4.33L19.12 17h-3.24Z"></path></svg>
</button>
<div class="md-select__inner">
<ul class="md-select__list">
<li class="md-select__item">
<a class="md-select__link" href="../../../../admin/kpanda/best-practice/etcd-backup.html" hreflang="zh">
              中文
            </a>
</li>
<li class="md-select__item">
<a class="md-select__link" href="etcd-backup.html" hreflang="en">
              English
            </a>
</li>
</ul>
</div>
</div>
</div>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<a aria-label="Share" class="md-search__icon md-icon" data-clipboard="" data-clipboard-text="" data-md-component="search-share" href="javascript:void(0)" tabindex="-1" title="Share">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"></path></svg>
</a>
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg>
</button>
</nav>
<div class="md-search__suggest" data-md-component="search-suggest"></div>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/sophongo/sophdoc" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 496 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg>
</div>
<div class="md-source__repository">
    sophongo/sophongo-docs
  </div>
</a>
</div>
</nav>
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../index.html">
        
  
    
  
  Home

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../end-user/index.html">
          
  
    
  
  User Manual

        </a>
</li>
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href="../../index.html">
          
  
    
  
  Administrator Manual

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../openapi/index.html">
          
  
    
  
  Developer Manual

        </a>
</li>
</ul>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="豐收二號檔案站" class="md-nav__button md-logo" data-md-component="logo" href="../../../index.html" title="豐收二號檔案站">
<img alt="logo" src="../../../../images/suanova.png"/>
</a>
    豐收二號檔案站
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/sophongo/sophdoc" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 496 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg>
</div>
<div class="md-source__repository">
    sophongo/sophongo-docs
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../index.html">
<span class="md-ellipsis">
    Home
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
<a class="md-nav__link" href="../../../end-user/index.html">
<span class="md-ellipsis">
    User Manual
  </span>
<span class="md-nav__icon md-icon"></span>
</a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../index.html">
<span class="md-ellipsis">
    Administrator Manual
  </span>
</a>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="true" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            Administrator Manual
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="">
<span class="md-ellipsis">
    Computing Services
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_3_2_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_2">
<span class="md-nav__icon md-icon"></span>
            Computing Services
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
<a class="md-nav__link" href="../../virtnest/install/index.html">
<span class="md-ellipsis">
    Cloud Host
  </span>
<span class="md-nav__icon md-icon"></span>
</a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3_2_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_2_2" id="__nav_3_2_2_label" tabindex="0">
<span class="md-ellipsis">
    Container Management
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_3_2_2_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_3_2_2">
<span class="md-nav__icon md-icon"></span>
            Container Management
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
<a class="md-nav__link" href="../clusters/create-cluster.html">
<span class="md-ellipsis">
    Cluster Management
  </span>
<span class="md-nav__icon md-icon"></span>
</a>
</li>
<li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
<a class="md-nav__link" href="../nodes/node-check.html">
<span class="md-ellipsis">
    Node Management
  </span>
<span class="md-nav__icon md-icon"></span>
</a>
</li>
<li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
<a class="md-nav__link" href="../namespaces/createns.html">
<span class="md-ellipsis">
    Namespaces
  </span>
<span class="md-nav__icon md-icon"></span>
</a>
</li>
<li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
<a class="md-nav__link" href="../scale/install-metrics-server.html">
<span class="md-ellipsis">
    Elastic Scaling
  </span>
<span class="md-nav__icon md-icon"></span>
</a>
</li>
<li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
<a class="md-nav__link" href="../helm/index.html">
<span class="md-ellipsis">
    Helm Apps
  </span>
<span class="md-nav__icon md-icon"></span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../olm/import-miniooperator.html">
<span class="md-ellipsis">
    Operator Applications
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
<a class="md-nav__link" href="../network/create-services.html">
<span class="md-ellipsis">
    Container Networking
  </span>
<span class="md-nav__icon md-icon"></span>
</a>
</li>
<li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
<a class="md-nav__link" href="../storage/pvc.html">
<span class="md-ellipsis">
    Container Storage
  </span>
<span class="md-nav__icon md-icon"></span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../custom-resources/create.html">
<span class="md-ellipsis">
    Custom Resources
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
<a class="md-nav__link" href="../configmaps-secrets/create-configmap.html">
<span class="md-ellipsis">
    Configurations and Secrets
  </span>
<span class="md-nav__icon md-icon"></span>
</a>
</li>
<li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
<a class="md-nav__link" href="../clusterops/latest-operations.html">
<span class="md-ellipsis">
    Cluster Operations
  </span>
<span class="md-nav__icon md-icon"></span>
</a>
</li>
<li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
<a class="md-nav__link" href="../inspect/index.html">
<span class="md-ellipsis">
    Cluster Inspection
  </span>
<span class="md-nav__icon md-icon"></span>
</a>
</li>
<li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
<a class="md-nav__link" href="../backup/index.html">
<span class="md-ellipsis">
    Backup and Recovery
  </span>
<span class="md-nav__icon md-icon"></span>
</a>
</li>
<li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
<a class="md-nav__link" href="../security/index.html">
<span class="md-ellipsis">
    Security Management
  </span>
<span class="md-nav__icon md-icon"></span>
</a>
</li>
<li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
<a class="md-nav__link" href="../permissions/permission-brief.html">
<span class="md-ellipsis">
    Permission Management
  </span>
<span class="md-nav__icon md-icon"></span>
</a>
</li>
<li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
<a class="md-nav__link" href="../gpu/index.html">
<span class="md-ellipsis">
    GPU 管理
  </span>
<span class="md-nav__icon md-icon"></span>
</a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3_2_2_17" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_2_2_17" id="__nav_3_2_2_17_label" tabindex="0">
<span class="md-ellipsis">
    Best Practices
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_3_2_2_17_label" class="md-nav" data-md-level="4">
<label class="md-nav__title" for="__nav_3_2_2_17">
<span class="md-nav__icon md-icon"></span>
            Best Practices
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    Backup and Restore etcd
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="etcd-backup.html">
<span class="md-ellipsis">
    Backup and Restore etcd
  </span>
</a>
<nav aria-label="导航" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      导航
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#environmental-information">
<span class="md-ellipsis">
      Environmental Information
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#prerequisites">
<span class="md-ellipsis">
      Prerequisites
    </span>
</a>
<nav aria-label="Prerequisites" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#install-the-etcdbrctl-tool">
<span class="md-ellipsis">
      Install the etcdbrctl tool
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#check-the-backup-data">
<span class="md-ellipsis">
      Check the backup data
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#shut-down-the-cluster">
<span class="md-ellipsis">
      Shut down the cluster
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#restore-the-backup">
<span class="md-ellipsis">
      Restore the backup
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#restore-the-cluster">
<span class="md-ellipsis">
      Restore the cluster
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="backup-mysql-on-nfs.html">
<span class="md-ellipsis">
    Cross-cluster Backup and Recovery for MySQL
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
<a class="md-nav__link" href="hardening-cluster.html">
<span class="md-ellipsis">
    Practices Related to Worker Clusters
  </span>
<span class="md-nav__icon md-icon"></span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="add-worker-node-on-global.html">
<span class="md-ellipsis">
    Global Cluster Worker Node Expansion
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="create-ubuntu-on-centos-platform.html">
<span class="md-ellipsis">
    Create Ubuntu Worker Cluster on CentOS
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="create-redhat9.2-on-centos-platform.html">
<span class="md-ellipsis">
    Create Red Hat Worker Cluster on CentOS
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="use-otherlinux-create-custer.html">
<span class="md-ellipsis">
    Create Cluster on Non-mainstream Operating Systems
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="kubean-low-version.html">
<span class="md-ellipsis">
    Deploy/Upgrade Kubean Compatible Version
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="limit-disk-usage-docker.html">
<span class="md-ellipsis">
    Limit Disk Space for Single Docker Container
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="k3s-lcm.html">
<span class="md-ellipsis">
    Edge Cluster Deployment and Management Practices
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
<a class="md-nav__link" href="co-located/index.html">
<span class="md-ellipsis">
    Offline Co-location
  </span>
<span class="md-nav__icon md-icon"></span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
<a class="md-nav__link" href="../../baize/oam/index.html">
<span class="md-ellipsis">
    AI Lab
  </span>
<span class="md-nav__icon md-icon"></span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="">
<span class="md-ellipsis">
    Management
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_3_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_3">
<span class="md-nav__icon md-icon"></span>
            Management
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
<a class="md-nav__link" href="../../insight/quickstart/res-plan/index.html">
<span class="md-ellipsis">
    Insight
  </span>
<span class="md-nav__icon md-icon"></span>
</a>
</li>
<li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
<a class="md-nav__link" href="../../ghippo/install/offline-install.html">
<span class="md-ellipsis">
    Global Management
  </span>
<span class="md-nav__icon md-icon"></span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
<a class="md-nav__link" href="../../../openapi/index.html">
<span class="md-ellipsis">
    Developer Manual
  </span>
<span class="md-nav__icon md-icon"></span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="导航" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      导航
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#environmental-information">
<span class="md-ellipsis">
      Environmental Information
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#prerequisites">
<span class="md-ellipsis">
      Prerequisites
    </span>
</a>
<nav aria-label="Prerequisites" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#install-the-etcdbrctl-tool">
<span class="md-ellipsis">
      Install the etcdbrctl tool
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#check-the-backup-data">
<span class="md-ellipsis">
      Check the backup data
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#shut-down-the-cluster">
<span class="md-ellipsis">
      Shut down the cluster
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#restore-the-backup">
<span class="md-ellipsis">
      Restore the backup
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#restore-the-cluster">
<span class="md-ellipsis">
      Restore the cluster
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1 id="etcd-backup-and-restore">etcd Backup and Restore<a class="headerlink" href="#etcd-backup-and-restore" title="Permanent link">¶</a></h1>
<p>Using the ETCD backup feature to create a backup policy, you can back up the etcd data of a specified cluster to S3 storage on a scheduled basis. This page focuses on how to restore the data that has been backed up to the current cluster.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul>
<li>AI platform ETCD backup restores are limited to backups and restores for the same cluster (with no change in the number of nodes and IP addresses). For example, after the etcd data of Cluster A is backed up, the backup data can only be restored to Cluster A, not to Cluster B.</li>
<li>The feature is recommended <a href="../backup/deployment.html">app backup and restore</a> for cross-cluster backups and restores.</li>
<li>First, create a backup policy to back up the current status. It is recommended to refer to the <a href="../backup/etcd-backup.html">ETCD backup</a>.</li>
</ul>
</div>
<p>The following is a specific case to illustrate the whole process of backup and restore.</p>
<h2 id="environmental-information">Environmental Information<a class="headerlink" href="#environmental-information" title="Permanent link">¶</a></h2>
<p>Begin with basic information about the target cluster and S3 storage for the restore. Here, MinIo is used as S3 storage, and the whole cluster has 3 control planes (3 etcd copies).</p>
<table>
<thead>
<tr>
<th>IP</th>
<th>Host</th>
<th>Role</th>
<th>Remarks</th>
</tr>
</thead>
<tbody>
<tr>
<td>10.6.212.10</td>
<td>host01</td>
<td>k8s-master01</td>
<td>k8s node 1</td>
</tr>
<tr>
<td>10.6.212.11</td>
<td>host02</td>
<td>k8s-master02</td>
<td>k8s node 2</td>
</tr>
<tr>
<td>10.6.212.12</td>
<td>host03</td>
<td>k8s-master03</td>
<td>k8s node 3</td>
</tr>
<tr>
<td>10.6.212.13</td>
<td>host04</td>
<td>minio</td>
<td>minio service</td>
</tr>
</tbody>
</table>
<h2 id="prerequisites">Prerequisites<a class="headerlink" href="#prerequisites" title="Permanent link">¶</a></h2>
<h3 id="install-the-etcdbrctl-tool">Install the etcdbrctl tool<a class="headerlink" href="#install-the-etcdbrctl-tool" title="Permanent link">¶</a></h3>
<p>To implement ETCD data backup and restore, you need to install the etcdbrctl open source tool on any of the above k8s nodes. This tool does not have binary files for the time being and needs to be compiled by itself. Refer to <a href="https://github.com/gardener/etcd-backup-restore/blob/master/doc/development/local_setup.md#build">the compilation mode</a>.</p>
<p>After installation, use the following command to check whether the tool is available:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>etcdbrctl<span class="w"> </span>-v
</code></pre></div>
<p>The expected output is as follows:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>INFO[0000] etcd-backup-restore Version: v0.23.0-dev
<a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a>INFO[0000] Git SHA: b980beec
<a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a>INFO[0000] Go Version: go1.19.3
<a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a>INFO[0000] Go OS/Arch: linux/amd64
</code></pre></div>
<h3 id="check-the-backup-data">Check the backup data<a class="headerlink" href="#check-the-backup-data" title="Permanent link">¶</a></h3>
<p>You need to check the following before restoring:</p>
<ul>
<li>Have you successfully backed up your data in AI platform</li>
<li>Check if backup data exists in S3 storage</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The backup of AI platform is a full data backup, and the full data of the last backup will be restored when restoring.</p>
</div>
<h3 id="shut-down-the-cluster">Shut down the cluster<a class="headerlink" href="#shut-down-the-cluster" title="Permanent link">¶</a></h3>
<p>Before backing up, the cluster must be shut down. The default clusters <strong>etcd</strong> and <strong>kube-apiserver</strong> are started as static pods. To close the cluster here means to move the static Pod manifest file out of the <strong>/etc/kubernetes/manifest</strong> directory, and the cluster will remove Pods to close the service.</p>
<ol>
<li>
<p>First, delete the previous backup data. Removing the data does not delete the existing etcd data, but refers to modifying the name of the etcd data directory. Wait for the backup to be successfully restored before deleting this directory. The purpose of this is to also try to restore the current cluster if the etcd backup restore fails. This step needs to be performed for each node.</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>rm<span class="w"> </span>-rf<span class="w"> </span>/var/lib/etcd_bak
</code></pre></div>
</li>
<li>
<p>The service then needs to be shut down <strong>kube-apiserver</strong> to ensure that there are no new changes to the etcd data. This step needs to be performed for each node.</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a>mv<span class="w"> </span>/etc/kubernetes/manifests/kube-apiserver.yaml<span class="w"> </span>/tmp/kube-apiserver.yaml
</code></pre></div>
</li>
<li>
<p>You also need to turn off the etcd service. This step needs to be performed for each node.</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a>mv<span class="w"> </span>/etc/kubernetes/manifests/etcd.yaml<span class="w"> </span>/tmp/etcd.yaml
</code></pre></div>
</li>
<li>
<p>Ensure that all control plane <strong>kube-apiserver</strong> and <strong>etcd</strong> services are turned off.</p>
</li>
<li>
<p>After shutting down all the nodes, use the following command to check <strong>etcd</strong> the cluster status. This command can be executed at any node.</p>
<blockquote>
<p>The <strong>endpoints</strong> value of needs to be replaced with the actual node name</p>
</blockquote>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a>etcdctl<span class="w"> </span>endpoint<span class="w"> </span>status<span class="w"> </span>--endpoints<span class="o">=</span>controller-node-1:2379,controller-node-2:2379,controller-node-3:2379<span class="w"> </span>-w<span class="w"> </span>table<span class="w"> </span><span class="se">\</span>
<a href="#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="w">  </span>--cacert<span class="o">=</span><span class="s2">"/etc/kubernetes/ssl/etcd/ca.crt"</span><span class="w"> </span><span class="se">\</span>
<a href="#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="w">  </span>--cert<span class="o">=</span><span class="s2">"/etc/kubernetes/ssl/apiserver-etcd-client.crt"</span><span class="w"> </span><span class="se">\</span>
<a href="#__codelineno-5-4" id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="w">  </span>--key<span class="o">=</span><span class="s2">"/etc/kubernetes/ssl/apiserver-etcd-client.key"</span>
</code></pre></div>
<p>The expected output is as follows, indicating that all <strong>etcd</strong> nodes have been destroyed:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a>{"level":"warn","ts":"2023-03-29T17:51:50.817+0800","logger":"etcd-client","caller":"v3@v3.5.6/retry_interceptor.go:62","msg":"retrying of unary invoker failed","target":"etcd-endpoints://0xc0001ba000/controller-node-1:2379","attempt":0,"error":"rpc error: code = DeadlineExceeded desc = latest balancer error: last connection error: connection error: desc = \"transport: Error while dialing dial tcp 10.5.14.31:2379: connect: connection refused\""}
<a href="#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a>Failed to get the status of endpoint controller-node-1:2379 (context deadline exceeded)
<a href="#__codelineno-6-3" id="__codelineno-6-3" name="__codelineno-6-3"></a>{"level":"warn","ts":"2023-03-29T17:51:55.818+0800","logger":"etcd-client","caller":"v3@v3.5.6/retry_interceptor.go:62","msg":"retrying of unary invoker failed","target":"etcd-endpoints://0xc0001ba000/controller-node-2:2379","attempt":0,"error":"rpc error: code = DeadlineExceeded desc = latest balancer error: last connection error: connection error: desc = \"transport: Error while dialing dial tcp 10.5.14.32:2379: connect: connection refused\""}
<a href="#__codelineno-6-4" id="__codelineno-6-4" name="__codelineno-6-4"></a>Failed to get the status of endpoint controller-node-2:2379 (context deadline exceeded)
<a href="#__codelineno-6-5" id="__codelineno-6-5" name="__codelineno-6-5"></a>{"level":"warn","ts":"2023-03-29T17:52:00.820+0800","logger":"etcd-client","caller":"v3@v3.5.6/retry_interceptor.go:62","msg":"retrying of unary invoker failed","target":"etcd-endpoints://0xc0001ba000/controller-node-1:2379","attempt":0,"error":"rpc error: code = DeadlineExceeded desc = latest balancer error: last connection error: connection error: desc = \"transport: Error while dialing dial tcp 10.5.14.33:2379: connect: connection refused\""}
<a href="#__codelineno-6-6" id="__codelineno-6-6" name="__codelineno-6-6"></a>Failed to get the status of endpoint controller-node-3:2379 (context deadline exceeded)
<a href="#__codelineno-6-7" id="__codelineno-6-7" name="__codelineno-6-7"></a>+----------+----+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
<a href="#__codelineno-6-8" id="__codelineno-6-8" name="__codelineno-6-8"></a>| ENDPOINT | ID | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |
<a href="#__codelineno-6-9" id="__codelineno-6-9" name="__codelineno-6-9"></a>+----------+----+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
<a href="#__codelineno-6-10" id="__codelineno-6-10" name="__codelineno-6-10"></a>+----------+----+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
</code></pre></div>
</li>
</ol>
<h2 id="restore-the-backup">Restore the backup<a class="headerlink" href="#restore-the-backup" title="Permanent link">¶</a></h2>
<p>You only need to restore the data of one node, and the etcd data of other nodes will be automatically synchronized.</p>
<ol>
<li>
<p>Set environment variables</p>
<p>Before restoring the data using etcdbrctl, run the following command to set the authentication information of the connection S3 as an environment variable:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">ECS_ENDPOINT</span><span class="o">=</span>http://10.6.212.13:9000<span class="w"> </span><span class="c1"># (1)</span>
<a href="#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="nb">export</span><span class="w"> </span><span class="nv">ECS_ACCESS_KEY_ID</span><span class="o">=</span>AKIAIOSFODNN7EXAMPLE<span class="w"> </span><span class="c1"># (2)</span>
<a href="#__codelineno-7-3" id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="nb">export</span><span class="w"> </span><span class="nv">ECS_SECRET_ACCESS_KEY</span><span class="o">=</span>wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY<span class="w"> </span><span class="c1"># (3)</span>
</code></pre></div>
<ol>
<li>Access points for S3 storage</li>
<li>S3 Stored username</li>
<li>S3 Stored Password</li>
</ol>
</li>
<li>
<p>Perform the restore operation</p>
<p>Run the etcdbrctl command line tool to perform the restore, which is the most critical step.</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a>etcdbrctl<span class="w"> </span>restore<span class="w"> </span>--data-dir<span class="w"> </span>/var/lib/etcd/<span class="w"> </span>--store-container<span class="o">=</span><span class="s2">"etcd-backup"</span><span class="w"> </span><span class="se">\ </span>
<a href="#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="w">  </span>--storage-provider<span class="o">=</span>ECS<span class="w"> </span><span class="se">\</span>
<a href="#__codelineno-8-3" id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="w">  </span>--initial-cluster<span class="o">=</span>controller-node1<span class="o">=</span>https://10.6.212.10:2380<span class="w"> </span><span class="se">\</span>
<a href="#__codelineno-8-4" id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="w">  </span>--initial-advertise-peer-urls<span class="o">=</span>https://10.6.212.10:2380<span class="w"> </span>
</code></pre></div>
<p>The parameters are described as follows:</p>
<ul>
<li>--data-dir: etcd data directory. This directory must be consistent with the etcd data directory so that etcd can load data normally.</li>
<li>--store-container: The location of S3 storage, the bucket in MinIO, must correspond to the bucket of data backup.</li>
<li>--initial-cluster: etcd is configured initially. The name of the etcd cluster must be the same as the original one.</li>
<li>--initial-advertise-peer-urls: etcd member inter-cluster access address. Must be consistent with etcd configuration.</li>
</ul>
<p>The expected output is as follows:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a>INFO[0000] Finding latest set of snapshot to recover from...
<a href="#__codelineno-9-2" id="__codelineno-9-2" name="__codelineno-9-2"></a>INFO[0000] Restoring from base snapshot: Full-00000000-00111147-1679991074  actor=restorer
<a href="#__codelineno-9-3" id="__codelineno-9-3" name="__codelineno-9-3"></a>INFO[0001] successfully fetched data of base snapshot in 1.241380207 seconds  actor=restorer
<a href="#__codelineno-9-4" id="__codelineno-9-4" name="__codelineno-9-4"></a>{"level":"info","ts":1680011221.2511616,"caller":"mvcc/kvstore.go:380","msg":"restored last compact revision","meta-bucket-name":"meta","meta-bucket-name-key":"finishedCompactRev","restored-compact-revision":110327}
<a href="#__codelineno-9-5" id="__codelineno-9-5" name="__codelineno-9-5"></a>{"level":"info","ts":1680011221.3045986,"caller":"membership/cluster.go:392","msg":"added member","cluster-id":"66638454b9dd7b8a","local-member-id":"0","added-peer-id":"123c2503a378fc46","added-peer-peer-urls":["https://10.6.212.10:2380"]}
<a href="#__codelineno-9-6" id="__codelineno-9-6" name="__codelineno-9-6"></a>INFO[0001] Starting embedded etcd server...              actor=restorer
<a href="#__codelineno-9-7" id="__codelineno-9-7" name="__codelineno-9-7"></a>
<a href="#__codelineno-9-8" id="__codelineno-9-8" name="__codelineno-9-8"></a>....
<a href="#__codelineno-9-9" id="__codelineno-9-9" name="__codelineno-9-9"></a>
<a href="#__codelineno-9-10" id="__codelineno-9-10" name="__codelineno-9-10"></a>{"level":"info","ts":"2023-03-28T13:47:02.922Z","caller":"embed/etcd.go:565","msg":"stopped serving peer traffic","address":"127.0.0.1:37161"}
<a href="#__codelineno-9-11" id="__codelineno-9-11" name="__codelineno-9-11"></a>{"level":"info","ts":"2023-03-28T13:47:02.922Z","caller":"embed/etcd.go:367","msg":"closed etcd server","name":"default","data-dir":"/var/lib/etcd","advertise-peer-urls":["http://localhost:0"],"advertise-client-urls":["http://localhost:0"]}
<a href="#__codelineno-9-12" id="__codelineno-9-12" name="__codelineno-9-12"></a>INFO[0003] Successfully restored the etcd data directory.
</code></pre></div>
<p>!!! note “You can check the YAML file of etcd for comparison to avoid configuration errors”</p>
<div class="highlight"><pre><span></span><code>```shell
cat /tmp/etcd.yaml | grep initial-
- --experimental-initial-corrupt-check=true
- --initial-advertise-peer-urls=https://10.6.212.10:2380
- --initial-cluster=controller-node-1=https://10.6.212.10:2380
```
</code></pre></div>
</li>
<li>
<p>The following command is executed on node 01 in order to restore the etcd service for node 01.</p>
<p>First, move the manifest file of etcd static Pod to the <strong>/etc/kubernetes/manifests</strong> directory, and kubelet will restart etcd:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-11-1" id="__codelineno-11-1" name="__codelineno-11-1"></a>mv<span class="w"> </span>/tmp/etcd.yaml<span class="w"> </span>/etc/kubernetes/manifests/etcd.yaml
</code></pre></div>
<p>Then wait for the etcd service to finish starting, and check the status of etcd. The default directory of etcd-related certificates is: <strong>/etc/kubernetes/ssl</strong> . If the cluster certificate is stored in another location, specify the corresponding path.</p>
<ul>
<li>
<p>Check the etcd cluster list:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-12-1" id="__codelineno-12-1" name="__codelineno-12-1"></a>etcdctl<span class="w"> </span>member<span class="w"> </span>list<span class="w"> </span>-w<span class="w"> </span>table<span class="w"> </span><span class="se">\</span>
<a href="#__codelineno-12-2" id="__codelineno-12-2" name="__codelineno-12-2"></a>--cacert<span class="o">=</span><span class="s2">"/etc/kubernetes/ssl/etcd/ca.crt"</span><span class="w"> </span><span class="se">\</span>
<a href="#__codelineno-12-3" id="__codelineno-12-3" name="__codelineno-12-3"></a>--cert<span class="o">=</span><span class="s2">"/etc/kubernetes/ssl/apiserver-etcd-client.crt"</span><span class="w"> </span><span class="se">\</span>
<a href="#__codelineno-12-4" id="__codelineno-12-4" name="__codelineno-12-4"></a>--key<span class="o">=</span><span class="s2">"/etc/kubernetes/ssl/apiserver-etcd-client.key"</span><span class="w"> </span>
</code></pre></div>
<p>The expected output is as follows:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-13-1" id="__codelineno-13-1" name="__codelineno-13-1"></a>+------------------+---------+-------------------+--------------------------+--------------------------+------------+
<a href="#__codelineno-13-2" id="__codelineno-13-2" name="__codelineno-13-2"></a>|        ID        | STATUS  |       NAME        |        PEER ADDRS        |       CLIENT ADDRS       | IS LEARNER |
<a href="#__codelineno-13-3" id="__codelineno-13-3" name="__codelineno-13-3"></a>+------------------+---------+-------------------+--------------------------+--------------------------+------------+
<a href="#__codelineno-13-4" id="__codelineno-13-4" name="__codelineno-13-4"></a>| 123c2503a378fc46 | started | controller-node-1 | https://10.6.212.10:2380 | https://10.6.212.10:2379 |      false |
<a href="#__codelineno-13-5" id="__codelineno-13-5" name="__codelineno-13-5"></a>+------------------+---------+-------------------+--------------------------+--------------------------+------------+
</code></pre></div>
</li>
<li>
<p>To view the status of controller-node-1:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-14-1" id="__codelineno-14-1" name="__codelineno-14-1"></a>etcdctl<span class="w"> </span>endpoint<span class="w"> </span>status<span class="w"> </span>--endpoints<span class="o">=</span>controller-node-1:2379<span class="w"> </span>-w<span class="w"> </span>table<span class="w"> </span><span class="se">\</span>
<a href="#__codelineno-14-2" id="__codelineno-14-2" name="__codelineno-14-2"></a>--cacert<span class="o">=</span><span class="s2">"/etc/kubernetes/ssl/etcd/ca.crt"</span><span class="w"> </span><span class="se">\</span>
<a href="#__codelineno-14-3" id="__codelineno-14-3" name="__codelineno-14-3"></a>--cert<span class="o">=</span><span class="s2">"/etc/kubernetes/ssl/apiserver-etcd-client.crt"</span><span class="w"> </span><span class="se">\</span>
<a href="#__codelineno-14-4" id="__codelineno-14-4" name="__codelineno-14-4"></a>--key<span class="o">=</span><span class="s2">"/etc/kubernetes/ssl/apiserver-etcd-client.key"</span>
</code></pre></div>
<p>The expected output is as follows:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-15-1" id="__codelineno-15-1" name="__codelineno-15-1"></a>+------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
<a href="#__codelineno-15-2" id="__codelineno-15-2" name="__codelineno-15-2"></a>|        ENDPOINT        |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |
<a href="#__codelineno-15-3" id="__codelineno-15-3" name="__codelineno-15-3"></a>+------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
<a href="#__codelineno-15-4" id="__codelineno-15-4" name="__codelineno-15-4"></a>| controller-node-1:2379 | 123c2503a378fc46 |   3.5.6 |   15 MB |      true |      false |         3 |       1200 |               1199 |        |
<a href="#__codelineno-15-5" id="__codelineno-15-5" name="__codelineno-15-5"></a>+------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
</code></pre></div>
</li>
</ul>
</li>
<li>
<p>Restore other node data</p>
<p>The above steps have restored the data of node 01. If you want to restore the data of other nodes, you only need to start the Pod of etcd and let etcd complete the data synchronization by itself.</p>
<ul>
<li>
<p>Do the same at both node 02 and node 03:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-16-1" id="__codelineno-16-1" name="__codelineno-16-1"></a>mv<span class="w"> </span>/tmp/etcd.yaml<span class="w"> </span>/etc/kubernetes/manifests/etcd.yaml
</code></pre></div>
</li>
<li>
<p>Data synchronization between etcd member clusters takes some time. You can check the etcd cluster status to ensure that all etcd clusters are normal:</p>
<p>Check whether the etcd cluster status is normal:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-17-1" id="__codelineno-17-1" name="__codelineno-17-1"></a>etcdctl<span class="w"> </span>member<span class="w"> </span>list<span class="w"> </span>-w<span class="w"> </span>table<span class="w"> </span><span class="se">\</span>
<a href="#__codelineno-17-2" id="__codelineno-17-2" name="__codelineno-17-2"></a>--cacert<span class="o">=</span><span class="s2">"/etc/kubernetes/ssl/etcd/ca.crt"</span><span class="w"> </span><span class="se">\</span>
<a href="#__codelineno-17-3" id="__codelineno-17-3" name="__codelineno-17-3"></a>--cert<span class="o">=</span><span class="s2">"/etc/kubernetes/ssl/apiserver-etcd-client.crt"</span><span class="w"> </span><span class="se">\</span>
<a href="#__codelineno-17-4" id="__codelineno-17-4" name="__codelineno-17-4"></a>--key<span class="o">=</span><span class="s2">"/etc/kubernetes/ssl/apiserver-etcd-client.key"</span>
</code></pre></div>
<p>The expected output is as follows:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-18-1" id="__codelineno-18-1" name="__codelineno-18-1"></a>+------------------+---------+-------------------+-------------------------+-------------------------+------------+
<a href="#__codelineno-18-2" id="__codelineno-18-2" name="__codelineno-18-2"></a>|        ID        | STATUS  |    NAME           |       PEER ADDRS        |      CLIENT ADDRS       | IS LEARNER |
<a href="#__codelineno-18-3" id="__codelineno-18-3" name="__codelineno-18-3"></a>+------------------+---------+-------------------+-------------------------+-------------------------+------------+
<a href="#__codelineno-18-4" id="__codelineno-18-4" name="__codelineno-18-4"></a>| 6ea47110c5a87c03 | started | controller-node-1 | https://10.5.14.31:2380 | https://10.5.14.31:2379 |      false |
<a href="#__codelineno-18-5" id="__codelineno-18-5" name="__codelineno-18-5"></a>| e222e199f1e318c4 | started | controller-node-2 | https://10.5.14.32:2380 | https://10.5.14.32:2379 |      false |
<a href="#__codelineno-18-6" id="__codelineno-18-6" name="__codelineno-18-6"></a>| f64eeda321aabe2d | started | controller-node-3 | https://10.5.14.33:2380 | https://10.5.14.33:2379 |      false |
<a href="#__codelineno-18-7" id="__codelineno-18-7" name="__codelineno-18-7"></a>+------------------+---------+-------------------+-------------------------+-------------------------+------------+
</code></pre></div>
<p>Check whether the three member nodes are normal:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-19-1" id="__codelineno-19-1" name="__codelineno-19-1"></a>etcdctl<span class="w"> </span>endpoint<span class="w"> </span>status<span class="w"> </span>--endpoints<span class="o">=</span>controller-node-1:2379,controller-node-2:2379,controller-node-3:2379<span class="w"> </span>-w<span class="w"> </span>table<span class="w"> </span><span class="se">\</span>
<a href="#__codelineno-19-2" id="__codelineno-19-2" name="__codelineno-19-2"></a>--cacert<span class="o">=</span><span class="s2">"/etc/kubernetes/ssl/etcd/ca.crt"</span><span class="w"> </span><span class="se">\</span>
<a href="#__codelineno-19-3" id="__codelineno-19-3" name="__codelineno-19-3"></a>--cert<span class="o">=</span><span class="s2">"/etc/kubernetes/ssl/apiserver-etcd-client.crt"</span><span class="w"> </span><span class="se">\</span>
<a href="#__codelineno-19-4" id="__codelineno-19-4" name="__codelineno-19-4"></a>--key<span class="o">=</span><span class="s2">"/etc/kubernetes/ssl/apiserver-etcd-client.key"</span>
</code></pre></div>
<p>The expected output is as follows:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-20-1" id="__codelineno-20-1" name="__codelineno-20-1"></a>+------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
<a href="#__codelineno-20-2" id="__codelineno-20-2" name="__codelineno-20-2"></a>|     ENDPOINT           |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |
<a href="#__codelineno-20-3" id="__codelineno-20-3" name="__codelineno-20-3"></a>+------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
<a href="#__codelineno-20-4" id="__codelineno-20-4" name="__codelineno-20-4"></a>| controller-node-1:2379 | 6ea47110c5a87c03 |   3.5.6 |   88 MB |      true |      false |         6 |     199008 |             199008 |        |
<a href="#__codelineno-20-5" id="__codelineno-20-5" name="__codelineno-20-5"></a>| controller-node-2:2379 | e222e199f1e318c4 |   3.5.6 |   88 MB |     false |      false |         6 |     199114 |             199114 |        |
<a href="#__codelineno-20-6" id="__codelineno-20-6" name="__codelineno-20-6"></a>| controller-node-3:2379 | f64eeda321aabe2d |   3.5.6 |   88 MB |     false |      false |         6 |     199316 |             199316 |        |
<a href="#__codelineno-20-7" id="__codelineno-20-7" name="__codelineno-20-7"></a>+------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
</code></pre></div>
</li>
</ul>
</li>
</ol>
<h2 id="restore-the-cluster">Restore the cluster<a class="headerlink" href="#restore-the-cluster" title="Permanent link">¶</a></h2>
<p>After the etcd data of all nodes are synchronized, the kube-apiserver can be restarted to restore the entire cluster to an accessible state:</p>
<ol>
<li>
<p>Restart the kube-apiserver service for node1</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-21-1" id="__codelineno-21-1" name="__codelineno-21-1"></a>mv<span class="w"> </span>/tmp/kube-apiserver.yaml<span class="w"> </span>/etc/kubernetes/manifests/kube-apiserver.yaml
</code></pre></div>
</li>
<li>
<p>Restart the kube-apiserver service for node2</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-22-1" id="__codelineno-22-1" name="__codelineno-22-1"></a>mv<span class="w"> </span>/tmp/kube-apiserver.yaml<span class="w"> </span>/etc/kubernetes/manifests/kube-apiserver.yaml
</code></pre></div>
</li>
<li>
<p>Restart the kube-apiserver service for node3</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-23-1" id="__codelineno-23-1" name="__codelineno-23-1"></a>mv<span class="w"> </span>/tmp/kube-apiserver.yaml<span class="w"> </span>/etc/kubernetes/manifests/kube-apiserver.yaml
</code></pre></div>
</li>
<li>
<p>After kubelet starts kube-apiserver, check whether the restored k8s data is normal:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-24-1" id="__codelineno-24-1" name="__codelineno-24-1"></a>kubectl<span class="w"> </span>get<span class="w"> </span>nodes
</code></pre></div>
<p>The expected output is as follows:</p>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-25-1" id="__codelineno-25-1" name="__codelineno-25-1"></a>NAME                STATUS     ROLES           AGE     VERSION
<a href="#__codelineno-25-2" id="__codelineno-25-2" name="__codelineno-25-2"></a>controller-node-1   Ready      &lt;none&gt;          3h30m   v1.25.4
<a href="#__codelineno-25-3" id="__codelineno-25-3" name="__codelineno-25-3"></a>controller-node-3   Ready      control-plane   3h29m   v1.25.4
<a href="#__codelineno-25-4" id="__codelineno-25-4" name="__codelineno-25-4"></a>controller-node-3   Ready      control-plane   3h28m   v1.25.4
</code></pre></div>
</li>
</ol>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"></path></svg>
  Back to top
</button>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
<div class="md-copyright__highlight">
      Copyright © 2016 - 2024 Suanova
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../../../..", "features": ["content.code.annotate", "content.code.copy", "content.tooltips", "navigation.indexes", "navigation.tabs", "navigation.instant", "navigation.prune", "navigation.sections", "navigation.tabs.sticky", "navigation.tracking", "navigation.top", "search.highlight", "search.suggest", "search.share", "toc.follow", "navigation.path"], "search": "../../../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
<script src="../../../../assets/javascripts/bundle.fe8b6f2b.min.js"></script>
<script src="../../../../stylesheets/zoom_image.js"></script>
<script>document$.subscribe(() => {
            window.update_swagger_ui_iframe_height = function (id) {
                var iFrameID = document.getElementById(id);
                if (iFrameID) {
                    full_height = (iFrameID.contentWindow.document.body.scrollHeight + 80) + "px";
                    iFrameID.height = full_height;
                    iFrameID.style.height = full_height;
                }
            }
        
            let iframe_id_list = []
            var iframes = document.getElementsByClassName("swagger-ui-iframe");
            for (var i = 0; i < iframes.length; i++) { 
                iframe_id_list.push(iframes[i].getAttribute("id"))
            }
        
            let ticking = true;
            
            document.addEventListener('scroll', function(e) {
                if (!ticking) {
                    window.requestAnimationFrame(()=> {
                        let half_vh = window.innerHeight/2;
                        for(var i = 0; i < iframe_id_list.length; i++) {
                            let element = document.getElementById(iframe_id_list[i])
                            if(element==null){
                                return
                            }
                            let diff = element.getBoundingClientRect().top
                            if(element.contentWindow.update_top_val){
                                element.contentWindow.update_top_val(half_vh - diff)
                            }
                        }
                        ticking = false;
                    });
                    ticking = true;
                }
            });
        
            const dark_scheme_name = "slate"
            
            window.scheme = document.body.getAttribute("data-md-color-scheme")
            const options = {
                attributeFilter: ['data-md-color-scheme'],
            };
            function color_scheme_callback(mutations) {
                for (let mutation of mutations) {
                    if (mutation.attributeName === "data-md-color-scheme") {
                        scheme = document.body.getAttribute("data-md-color-scheme")
                        var iframe_list = document.getElementsByClassName("swagger-ui-iframe")
                        for(var i = 0; i < iframe_list.length; i++) {
                            var ele = iframe_list.item(i);
                            if (ele) {
                                if (scheme === dark_scheme_name) {
                                    ele.contentWindow.enable_dark_mode();
                                } else {
                                    ele.contentWindow.disable_dark_mode();
                                }
                            }
                        }
                    }
                }
            }
            observer = new MutationObserver(color_scheme_callback);
            observer.observe(document.body, options);
            })</script></body>
</html>